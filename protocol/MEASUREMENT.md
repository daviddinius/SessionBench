# Measurement Protocol

## Overview

This document defines exactly what to measure and how during SessionBench runs.

---

## Token Measurement

### How to Capture

Claude Code outputs token information. Capture with:

```bash
# Run session and capture all output
claude-code 2>&1 | tee session-XX.log

# Or use the wrapper script (see scripts/run-session.sh)
```

### Metrics

| Metric | Description |
|--------|-------------|
| `input_tokens` | Tokens sent to model (includes context) |
| `output_tokens` | Tokens generated by model |
| `total_tokens` | Sum of input + output |
| `context_files` | List of files loaded into context |

### Data Format

```json
{
  "tokens": {
    "input": 45230,
    "output": 12456,
    "total": 57686,
    "context_files": ["CLAUDE.md", "src/index.ts"]
  }
}
```

---

## Time Measurement

### Metrics

| Metric | Description |
|--------|-------------|
| `duration_seconds` | Wall clock time from prompt to completion |
| `timestamp_start` | ISO 8601 timestamp when session began |
| `timestamp_end` | ISO 8601 timestamp when session ended |

### How to Capture

```bash
START=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
# ... run session ...
END=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
```

---

## Quality Metrics

### Automated Metrics

Run after each session:

```bash
# Test pass rate
npm test 2>&1 | tee test-output.log
TEST_PASS=$?

# Coverage (if Jest configured)
npm test -- --coverage

# Lint
npm run lint 2>&1
LINT_PASS=$?

# Build
npm run build 2>&1
BUILD_PASS=$?
```

### Data Format

```json
{
  "quality": {
    "tests_passing": true,
    "test_count": 24,
    "test_failures": 0,
    "coverage_percent": 78.5,
    "build_succeeds": true,
    "lint_clean": true
  }
}
```

### Feature Checklist

Each session has specific success criteria. Score as:

```json
{
  "features": {
    "requirement_1": true,
    "requirement_2": true,
    "requirement_3": false,
    "features_complete": 2,
    "features_total": 3
  }
}
```

---

## Decision Consistency

### Tracking Decisions

After each session, extract key decisions made:

```json
{
  "decisions": {
    "markdown_parser": "marked",
    "template_engine": "handlebars",
    "plugin_pattern": "hooks",
    "config_format": "js"
  }
}
```

### Drift Detection

Compare decisions across sessions. Flag:

- **CONSISTENT**: Same decision maintained
- **DRIFT**: Decision changed without prompt requiring it
- **JUSTIFIED_CHANGE**: Decision changed WITH documented reasoning

### Drift Score

```
drift_score = (consistent_decisions) / (total_tracked_decisions)
```

Target: >80% consistency for context-persistence conditions.

---

## Failure Mode Detection

### Session Amnesia

**Detection:** Decision changed in later session without justification.

```json
{
  "session_amnesia": {
    "detected": true,
    "evidence": "Template engine changed from handlebars to ejs in Session 7 without explanation"
  }
}
```

### TDD Skipping

**Detection:** Git commits show implementation before tests.

```bash
# Check commit order
git log --oneline --name-only --diff-filter=A |
  # Analyze if test files appear before implementation
```

### Verification Skipping

**Detection:** Claims "done" but tests fail or weren't run.

```json
{
  "verification_skip": {
    "detected": true,
    "evidence": "Session ended without running npm test"
  }
}
```

### Debug Thrashing

**Detection:** Multiple unrelated changes, no clear diagnosis.

Review git diff for:
- Changes to unrelated files
- Multiple reverted attempts
- No added tests for the bug

### Scope Creep

**Detection:** Features added that weren't in the prompt.

Review diff for functionality not requested.

---

## Data Storage

### Directory Structure

```
data/runs/
  run-001-baseline/
    metadata.json
    sessions/
      session-01.json
      session-01.log
      session-02.json
      session-02.log
      ...
    git-snapshots/
      after-session-01.tar.gz
      after-session-02.tar.gz
      ...
    summary.json
```

### Session Data Schema

```json
{
  "$schema": "sessionbench-session-v1",
  "run_id": "run-001-baseline",
  "condition": "baseline",
  "session_number": 3,
  "prompt_id": "SESSION-03",

  "timing": {
    "start": "2026-01-05T10:30:00Z",
    "end": "2026-01-05T10:47:23Z",
    "duration_seconds": 1043
  },

  "tokens": {
    "input": 45230,
    "output": 12456,
    "total": 57686,
    "context_files": []
  },

  "quality": {
    "tests_passing": true,
    "test_count": 12,
    "coverage_percent": 78.5,
    "build_succeeds": true,
    "lint_clean": true,
    "features_complete": 3,
    "features_total": 4
  },

  "decisions": {
    "template_engine": "handlebars"
  },

  "failure_modes": {
    "session_amnesia": false,
    "tdd_skipped": false,
    "verification_skipped": false,
    "debug_thrashing": false,
    "scope_creep": false
  },

  "operator_notes": ""
}
```

### Run Summary Schema

```json
{
  "run_id": "run-001-baseline",
  "condition": "baseline",
  "operator": "david",
  "start_date": "2026-01-05",
  "end_date": "2026-01-08",

  "totals": {
    "sessions_completed": 15,
    "total_tokens": 857000,
    "total_duration_minutes": 412,
    "tests_passing_final": true,
    "features_complete": 14,
    "features_total": 15
  },

  "decision_consistency": {
    "score": 0.73,
    "drift_events": 3
  },

  "failure_mode_counts": {
    "session_amnesia": 2,
    "tdd_skipped": 5,
    "verification_skipped": 1,
    "debug_thrashing": 1,
    "scope_creep": 0
  }
}
```
